<!DOCTYPE html>
<html lang="kz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>–î–∞–ª–∞ –ë–∞—Ç—ã—Ä—ã / Steppe Warrior</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: none; }
        
        body {
            background-color: #000;
            color: #d4af37;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            user-select: none;
            display: flex; align-items: center; justify-content: center;
        }

        #game-wrapper {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: #000;
        }

        canvas {
            display: block; width: 100%; height: 100%;
            image-rendering: pixelated; 
        }

        .scanlines {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 10; opacity: 0.3;
        }

        /* UI LAYER - LOWERED TO 18% TO CLEAR BROWSER BAR */
        #ui-layer {
            position: absolute; 
            top: 18%; 
            left: 15px; 
            right: 15px;
            display: none; justify-content: space-between; align-items: flex-start;
            pointer-events: none; z-index: 20;
            font-weight: bold; font-size: 10px;
        }

        .stat-box { display: flex; flex-direction: column; gap: 8px; }
        
        .stat-row { 
            display: flex; flex-direction: column; 
            text-shadow: 1px 1px 0 #000; 
            margin-bottom: 5px;
        }
        .stat-label { color: #aaa; font-size: 9px; margin-bottom: 2px; letter-spacing: 1px; }
        .stat-val { font-size: 16px; display: flex; align-items: center; gap: 5px; }

        #health-container { width: 90px; height: 12px; background: #222; border: 1px solid #8d6e63; }
        #health-fill { width: 100%; height: 100%; background: #b71c1c; transition: width 0.1s linear; }
        
        #horse-bar-container { width: 90px; height: 5px; background: #222; border: 1px solid #ffd700; display: none; margin-top: 2px; }
        #horse-bar-fill { width: 100%; height: 100%; background: #ffd700; }
        
        #msg-center {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 30; width: 100%;
        }
        .flash-msg {
            font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #000;
            margin-bottom: 5px; animation: popFade 2s forwards;
        }
        @keyframes popFade { 0% { opacity: 0; transform: scale(0.5); } 20% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(1.0); } }

        /* CONTROLS */
        #mobile-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 40; display: none;
        }
        .control-zone { position: absolute; pointer-events: auto; }

        #dpad-area {
            left: 20px; bottom: 30px; width: 140px; height: 140px;
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(212, 175, 55, 0.2);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
        }
        #dpad-knob {
            width: 50px; height: 50px; background: rgba(212, 175, 55, 0.5);
            border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: transform 0.05s;
        }

        #action-btn {
            right: 30px; bottom: 50px; width: 90px; height: 90px;
            background: rgba(183, 28, 28, 0.5); border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
        }
        #action-btn:active { background: rgba(255, 255, 255, 0.6); transform: scale(0.95); }
        .btn-icon { font-size: 30px; opacity: 0.9; filter: drop-shadow(2px 2px 0 #000); }

        /* OVERLAYS */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 5, 0, 0.96);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; padding: 20px; overflow-y: auto;
        }

        h1 { text-shadow: 4px 4px 0 #000; margin: 0; color: #d84315; font-size: 5vh; text-transform: uppercase; text-align: center; line-height: 1.1; }
        h2 { color: #d4af37; font-size: 2.5vh; margin: 5px 0 15px 0; text-align: center; opacity: 0.9; }
        
        .story-text {
            color: #ef5350; font-weight: bold; margin-bottom: 10px; 
            text-shadow: 1px 1px 0 #000; font-size: 13px; text-align: center;
            max-width: 600px; line-height: 1.4;
        }
        .small-hint {
            color: #888; font-size: 10px; margin-bottom: 20px; text-align: center; font-style: italic;
        }

        input {
            background: #212121; border: 2px solid #d4af37; color: #fff;
            padding: 12px; font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold;
            text-align: center; margin-bottom: 15px; outline: none; text-transform: uppercase; width: 70%; max-width: 300px;
        }
        
        button {
            background: #ff8f00; color: #000; border: 2px solid #3e2723;
            padding: 15px 40px; font-family: inherit; font-weight: bold; font-size: 20px;
            cursor: pointer; box-shadow: 4px 4px 0 #000; transition: transform 0.1s; margin-bottom: 10px;
        }
        button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 #000; }

        .credits { margin-top: 15px; font-size: 10px; color: #666; text-align: center; padding-bottom: 20px; }
        .credits a { color: #d4af37; text-decoration: none; font-weight: bold; }
        
        .ai-credit {
            margin-top: 20px; font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1px;
        }

        .share-box {
            background: rgba(212, 175, 55, 0.1); border: 1px dashed #d4af37;
            padding: 10px; margin: 10px 0; width: 95%; max-width: 500px;
            text-align: center; color: #fff; font-size: 12px; line-height: 1.5;
        }
        
        .share-warning {
            color: #ef5350; font-style: italic; font-size: 11px; margin-top: 5px;
        }

        #rotate-device {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999; display: none;
            flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        @media (orientation: portrait) { #rotate-device { display: flex; } }
        
        .hof-container {
            background: rgba(20, 10, 5, 0.9); padding: 5px; border: 1px solid #5d4037; 
            width: 98%; max-width:600px; margin-bottom: 10px;
        }
        table { width:100%; color:#fff; font-size:11px; text-align:center; border-collapse:collapse; }
        th { border-bottom:1px solid #d4af37; padding:4px; color:#d4af37; font-size: 10px; vertical-align: bottom;}
        td { border-bottom:1px solid #444; padding:4px; }
    </style>
</head>
<body>

<div id="rotate-device">
    <h1>‚Üª</h1>
    <p>ROTATE DEVICE / –¢–ï–õ–ï–§–û–ù–î–´ –ë“∞–†–´“¢–´–ó</p>
</div>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>
    <div class="scanlines"></div>
    <div id="msg-center"></div>

    <div id="ui-layer">
        <div class="stat-box">
            <div style="display:flex; align-items:center; gap:8px; color: #b71c1c;">
                ‚ù§Ô∏è <div id="health-container"><div id="health-fill"></div></div>
            </div>
            <div id="horse-bar-container"><div id="horse-bar-fill"></div></div>
        </div>
        
        <div class="stat-box" style="align-items: flex-end;">
            <div class="stat-row" style="color:#76ff03">
                 <div class="stat-label">SAVED / “ö“∞–¢“ö–ê–†–´–õ–î–´</div>
                 <div class="stat-val"><span style="font-size:18px">üòä</span> <span id="ui-saved">0</span></div>
            </div>
            <div class="stat-row" style="color:#ef5350">
                 <div class="stat-label">LOST / –ñ–û“í–ê–õ–î–´</div>
                 <div class="stat-val"><span style="font-size:18px">üíÄ</span> <span id="ui-lost">0</span></div>
            </div>
            <div class="stat-row" style="color:#fff">
                 <div class="stat-label">KILLED / –ñ–û–ô–´–õ–î–´</div>
                 <div class="stat-val"><span style="font-size:18px">‚öîÔ∏è</span> <span id="ui-score">0</span></div>
            </div>
        </div>
    </div>

    <div id="mobile-controls">
        <div id="dpad-area" class="control-zone">
            <div id="dpad-knob"></div>
        </div>
        <div id="action-btn" class="control-zone">
            <span class="btn-icon">‚öîÔ∏è</span>
        </div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>–î–ê–õ–ê –ë–ê–¢–´–†–´</h1>
        <h2>STEPPE WARRIOR</h2>
        
        <div class="story-text">
            –î–∞–ª–∞–¥–∞ —Å–æ“ì—ã—Å –±–∞—Å—Ç–∞–ª–¥—ã. –•–∞–ª—ã“õ—Ç—ã “õ–æ—Ä“ì–∞. –ö–∏—ñ–∑ “Ø–π–¥—ñ “õ–æ—Ä“ì–∞. –°–µ–Ω —Å–æ“£“ì—ã –±–∞—Ç—ã—Ä—Å—ã“£.<br><br>
            War is upon the steppe. Save the people. Save the Yurt. You are the last warrior.
        </div>
        
        <div class="small-hint">
            1000 –∞–¥–∞–º–¥—ã “õ“±—Ç“õ–∞—Ä—Å–∞“£ - –∂–µ“£—ñ—Å, –±–∞—Ç—ã—Ä!<br>
            If you save 1000 people you win, warrior!
        </div>

        <input type="text" id="username" placeholder="–ï–°–Ü–ú–Ü“¢–Ü–ó / YOUR NAME" maxlength="12">
        <button id="start-btn">–ê–õ“í–ê / START</button>
        
        <div class="ai-credit">Created using AI tools by Yadykar Ibraimov</div>
    </div>

    <div id="victory-screen" class="overlay" style="display: none;">
        <h1 style="color:#76ff03; font-size: 5vh;">VICTORY!</h1>
        <h2 style="color:#fff; font-size: 2.5vh;">–ñ–ï“¢–Ü–°!</h2>
        
        <p style="color:#fff; font-weight:bold; font-size: 16px; margin: 20px 0;">
            Congratulations! You saved the Steppe!<br>
            “ö“±—Ç—Ç—ã“õ—Ç–∞–π–º—ã–∑! –°—ñ–∑ –¥–∞–ª–∞–Ω—ã —Å–∞“õ—Ç–∞–ø “õ–∞–ª–¥—ã“£—ã–∑!
        </p>

        <div class="share-box">
            Please share your stats online and tag me!<br>
            <a href="https://www.instagram.com/yangisar/" target="_blank" style="color:#ffd700">@yangisar</a>
            <div class="share-warning">
                This website will not save your stats for everyone to see unless you share your success!
            </div>
        </div>
        
        <button onclick="location.reload()">AGAIN / “ö–ê–ô–¢–ê</button>
        <div class="ai-credit">Created using AI tools by Yadykar Ibraimov</div>
    </div>

    <div id="game-over" class="overlay" style="display: none;">
        <h1 style="color:#b71c1c;">–û–ô–´–ù –ê–Ø“ö–¢–ê–õ–î–´</h1>
        <h2 style="color:#b71c1c; font-size: 2.5vh; margin-bottom:15px;">GAME OVER</h2>
        
        <p style="color:#fff; font-weight:bold; font-size: 14px; margin-bottom: 5px;">
            –î–∞–ª–∞ –±–∞—Ç—ã—Ä—ã “õ–∞–∑–∞ —Ç–∞–ø—Ç—ã. –ë—ñ–∑–¥—ñ –µ–Ω–¥—ñ –∫—ñ–º “õ“±—Ç“õ–∞—Ä–∞–¥—ã?<br>
            The Steppe Warrior is dead. Who will save us now?
        </p>

        <div class="share-box">
            Please share your stats online and tag me!<br>
            <a href="https://www.instagram.com/yangisar/" target="_blank" style="color:#ffd700">@yangisar</a>
            <div class="share-warning">
                This website will not save your stats for everyone to see unless you share your success!
            </div>
        </div>

        <div class="hof-container">
            <h3 style="color:#d4af37; text-align:center; margin:0 0 5px 0; font-size:14px;">–î–ê“¢“ö –ó–ê–õ–´ / HALL OF FAME</h3>
            <table>
                <thead>
                    <tr>
                        <th>ATY<br>NAME</th>
                        <th>–ñ–û–ô–´–õ–î–´<br>KILLED</th>
                        <th>“ö“∞–¢“ö–ê–†–´–õ–î–´<br>SAVED</th>
                        <th>–ñ–û“í–ê–õ–î–´<br>LOST</th>
                    </tr>
                </thead>
                <tbody id="hof-body"></tbody>
            </table>
        </div>
        
        <button onclick="location.reload()">“ö–ê–ô–¢–ê –û–ô–ù–ê–£ / AGAIN</button>
        <div class="ai-credit">Created using AI tools by Yadykar Ibraimov</div>
    </div>
</div>

<script>
/**
 * DALA BATYRY - ULTIMATE STABLE BUILD
 * Crash Fix: Double Loop Prevention & Strict Memory Caps
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });

let CANVAS_H = 240; 
let CANVAS_W = 0; 
let HORIZON = 0; 
let audioCtx = null;
let audioEnabled = false;
let loopId = null; // CRITICAL: To kill previous loops

// --- BOSSES ---
const FINANCIAL_BOSSES = [
    { name: "–ò–ü–û–¢–ï–ö–ê", color: "#b71c1c", hp: 40, w: 45, h: 45 },
    { name: "–ö–†–ï–î–ò–¢", color: "#0d47a1", hp: 35, w: 30, h: 40 },
    { name: "–î–ï–í–ê–õ–¨–í–ê–¶–ò–Ø", color: "#e65100", hp: 30, w: 35, h: 35 },
    { name: "–ò–ù–§–õ–Ø–¶–ò–Ø", color: "#1b5e20", hp: 50, w: 50, h: 50 }
];

const WEAPONS = {
    sword: { name: "–°–ï–ú–°–ï–†", range: 24, dmg: 1, color: "#eceff1", speed: 12 },
    axe: { name: "–ê–ô–ë–ê–õ–¢–ê", range: 20, dmg: 2, color: "#78909c", speed: 18 },
    spear: { name: "–ù–ê–ô–ó–ê", range: 35, dmg: 1.5, color: "#d7ccc8", speed: 15 },
    mace: { name: "–®–û“ö–ü–ê–†", range: 22, dmg: 3, color: "#4e342e", speed: 22 }
};

const PLEAS_RAW = `–ö”©–º–µ–∫!|Help!|–ü–æ–º–æ–≥–∏—Ç–µ!|”®–ª–µ–º—ñ–Ω!|“ö“±—Ç“õ–∞—Ä!|Ahhh!|Nooo!|–ñ–µ—Ä –∂“±—Ç“õ—ã—Ä!|–¢–µ–∑!|Fast!|–ë—ã—Å—Ç—Ä–µ–µ!|–ê–ø–∞!|Mom!|–û–π–±–∞–π!|–°“±–º–¥—ã“õ!|“ö–∞—à!|Run!|–ë–µ–≥–∏!|–ë–∞—Ç—ã—Ä!|Hero!|–ñ”ô—Ä–¥–µ–º!|SOS!|–ö–µ—Ç!|Go away!|–ñ–∞—É!|Enemy!|–ö”©–º–µ–∫—Ç–µ—Å!|Assist!|Save me!|–°–ø–∞—Å–∏!|–¢”ô“£—ñ—Ä—ñ–º!|–ë–∞–ª–∞–º!|My child!|–û—Ç–∞–Ω—ã–º!|–ï–ª—ñ–º!|People!|–°–∞“õ—Ç–∞!|Protect!|–ñ–∞—Ä–∞–ª–∞–Ω–¥—ã–º!|Hurt!|–ë–µ—Ä—ñ–ª–º–µ!|–ê–ª“ì–∞!|Forward!|–°–æ“õ!|Hit!|–ë–µ–π!|–ê—Ä—Ç—ã–º–¥–∞!|Behind!|–ê—è–º–∞!|Mercy!|–ù–∞–º—ã—Å!|Honor!|–ï—Ä–ª—ñ–∫!|Valor!|–ê–±–∞–π–ª–∞!|Watch out!|“Æ–π–≥–µ!|Home!|–î–∞–ª–∞!|Steppe!|–ê—à–ø—ã–Ω!|Hungry!|–ö“Ø—à!|Power!|–ñ—ñ–≥–µ—Ä!|Will!|“Æ–º—ñ—Ç!|Hope!|–ñ–µ“£—ñ—Å!|Victory!|–ë–æ—Å—Ç–∞–Ω–¥—ã“õ!|Freedom!|Pain!|–ë–æ–ª—å–Ω–æ!|Please!|”®—Ç—ñ–Ω–µ–º!|Stop!|–¢–æ“õ—Ç–∞!|Glory!|–î–∞“£“õ!`;
const PLEAS = PLEAS_RAW.split('|').filter(s => s.trim().length > 0);

const UI = {
    start: document.getElementById('start-screen'),
    gameOver: document.getElementById('game-over'),
    victory: document.getElementById('victory-screen'),
    hud: document.getElementById('ui-layer'),
    controls: document.getElementById('mobile-controls'),
    hp: document.getElementById('health-fill'),
    saved: document.getElementById('ui-saved'),
    lost: document.getElementById('ui-lost'),
    score: document.getElementById('ui-score'),
    weapon: document.getElementById('ui-weapon'),
    horseBar: document.getElementById('horse-bar-container'),
    horseFill: document.getElementById('horse-bar-fill'),
    msg: document.getElementById('msg-center'),
    hofBody: document.getElementById('hof-body'),
    input: document.getElementById('username'),
    startBtn: document.getElementById('start-btn'),
    dpad: document.getElementById('dpad-area'),
    knob: document.getElementById('dpad-knob'),
    action: document.getElementById('action-btn')
};

let game = {
    active: false, frame: 0, username: "NOMAD",
    score: 0, saved: 0, lost: 0, 
    nextHorse: 10, nextFinancialBoss: 70, finalBossSpawned: false,
    bossTimer: 0, 
    yurt: { x: 0, y: 0 },
    bgMountains: [], groundDecals: []
};

let player = {
    x: 100, y: 100, w: 14, h: 26, hp: 100, maxHp: 100,
    dir: 1, attacking: false, attackTimer: 0, cooldown: 0,
    mounted: false, mountTimer: 0, maxMountTime: 600,
    weaponType: 'sword'
};

let enemies = [];
let civilians = [];
let items = [];
let particles = [];
const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, Space: false };
let musicInterval = null;

// --- AUDIO (SAFE MODE) ---
function initAudio() {
    try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!audioCtx) audioCtx = new AC();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const b = audioCtx.createBuffer(1, 1, 22050);
        const s = audioCtx.createBufferSource();
        s.buffer = b;
        s.connect(audioCtx.destination);
        s.start(0);
        audioEnabled = true; 
    } catch(e){ 
        console.log("Audio disabled.");
        audioEnabled = false; 
    }
}

function playSnd(t) {
    if(!audioEnabled || !audioCtx || audioCtx.state !== 'running') return;
    try {
        const now = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        if(t==='swing') { o.type='sawtooth'; o.frequency.setValueAtTime(150,now); o.frequency.linearRampToValueAtTime(600,now+0.1); g.gain.setValueAtTime(0.08,now); g.gain.linearRampToValueAtTime(0,now+0.15); o.start(); o.stop(now+0.15); }
        else if(t==='hit') { o.type='square'; o.frequency.setValueAtTime(80,now); g.gain.setValueAtTime(0.15,now); g.gain.exponentialRampToValueAtTime(0,now+0.1); o.start(); o.stop(now+0.1); }
        else if(t==='collect') { o.type='sine'; o.frequency.setValueAtTime(600,now); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.2); o.start(); o.stop(now+0.2); }
        else if(t==='boss') { o.type='sawtooth'; o.frequency.setValueAtTime(60,now); g.gain.setValueAtTime(0.3,now); g.gain.linearRampToValueAtTime(0,now+1.5); o.start(); o.stop(now+1.5); }
        else if(t==='weapon') { o.type='square'; o.frequency.setValueAtTime(300,now); o.frequency.linearRampToValueAtTime(600,now+0.2); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.3); o.start(); o.stop(now+0.3); }
        else if(t==='horse') { o.type='triangle'; o.frequency.setValueAtTime(200,now); o.frequency.linearRampToValueAtTime(100,now+0.3); g.gain.setValueAtTime(0.1,now); g.gain.linearRampToValueAtTime(0,now+0.3); o.start(); o.stop(now+0.3); }
    } catch(e){}
}

function startMusic() {
    if(musicInterval) clearInterval(musicInterval);
    musicInterval = setInterval(()=>{
        if(!game.active || !audioEnabled || !audioCtx) return;
        try {
            const now = audioCtx.currentTime;
            const n = (f,d) => { let o=audioCtx.createOscillator();let g=audioCtx.createGain();o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.03,now+d);g.gain.linearRampToValueAtTime(0,now+d+0.2);o.connect(g);g.connect(audioCtx.destination);o.start(now+d);o.stop(now+d+0.25); };
            n(146,0); n(220,0.1); n(146,0.2); if(Math.random()>0.7) n(293,0.3);
        } catch(e){}
    }, 400);
}

// --- RESIZE (DEBOUNCED) ---
function resize() {
    const scale = window.innerHeight / CANVAS_H;
    canvas.height = CANVAS_H;
    canvas.width = window.innerWidth / scale; 
    CANVAS_W = canvas.width;
    HORIZON = CANVAS_H * 0.45; 
    game.yurt = { x: CANVAS_W/2 - 25, y: HORIZON - 20 };
    // Only generate if empty. Prevents memory overflow on mobile scroll.
    if(game.bgMountains.length === 0) generateEnvironment();
}
window.addEventListener('resize', resize);
resize();

function generateEnvironment() {
    game.bgMountains = []; game.groundDecals = [];
    let back = [], front = [];
    for(let x=0; x<=CANVAS_W; x+=10) back.push({x:x, y:HORIZON-25-Math.random()*30});
    for(let x=0; x<=CANVAS_W; x+=15) front.push({x:x, y:HORIZON-10-Math.random()*15});
    game.bgMountains.push({c:"#2c2035", p:back});
    game.bgMountains.push({c:"#1a1423", p:front});
    for(let i=0; i<30; i++) game.groundDecals.push({ 
        x: Math.random()*CANVAS_W, y:HORIZON+Math.random()*(CANVAS_H-HORIZON),
        c: Math.random()<0.5?"#2e4c21":"#466030", w:1+Math.random(), h:1, type:'grass'
    });
}

function showMsg(text, color) {
    const el = document.createElement('div');
    el.innerText = text; el.className = 'flash-msg'; el.style.color = color;
    UI.msg.appendChild(el);
    setTimeout(() => el.remove(), 2000);
}

// --- CONTROLS ---
let touchId = null;
function handleTouchStart(e) {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
        let t = e.changedTouches[i];
        if (t.clientX < window.innerWidth / 2) { 
            touchId = t.identifier;
            updateJoystick(t.clientX, t.clientY);
        }
    }
}
function handleTouchMove(e) {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
        if (e.changedTouches[i].identifier === touchId) updateJoystick(e.changedTouches[i].clientX, e.changedTouches[i].clientY);
    }
}
function handleTouchEnd(e) {
    e.preventDefault();
    for (let i = 0; i < e.changedTouches.length; i++) {
        if (e.changedTouches[i].identifier === touchId) { touchId = null; resetJoystick(); }
    }
}
function updateJoystick(tx, ty) {
    const rect = UI.dpad.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    const maxDist = rect.width / 2;
    let dx = tx - cx; let dy = ty - cy;
    let dist = Math.sqrt(dx*dx + dy*dy);
    if (dist > maxDist) { dx = (dx / dist) * maxDist; dy = (dy / dist) * maxDist; }
    UI.knob.style.transform = `translate(${dx}px, ${dy}px)`;
    keys.ArrowRight = dx > 20; keys.ArrowLeft = dx < -20;
    keys.ArrowDown = dy > 20; keys.ArrowUp = dy < -20;
}
function resetJoystick() {
    UI.knob.style.transform = `translate(0px, 0px)`;
    keys.ArrowUp = keys.ArrowDown = keys.ArrowLeft = keys.ArrowRight = false;
}
UI.action.addEventListener('touchstart', (e) => { e.preventDefault(); if(game.active) attack(); });
UI.dpad.addEventListener('touchstart', handleTouchStart);
UI.dpad.parentElement.addEventListener('touchmove', handleTouchMove);
UI.dpad.parentElement.addEventListener('touchend', handleTouchEnd);
window.onkeydown=e=>{keys[e.code]=true;if(e.code==='Space'&&game.active)attack();};
window.onkeyup=e=>keys[e.code]=false;

// --- GAME LOGIC ---

UI.startBtn.addEventListener('click', () => {
    initAudio(); 
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch((e)=>{});
    }
    startGame();
});

function startGame() {
    // PREVENT DOUBLE START CRASH
    if(loopId) cancelAnimationFrame(loopId);

    const n = UI.input.value.trim(); if(!n){alert("NAME?");return;}
    resize();
    game.username=n; game.active=true; game.frame=0; game.score=0; game.saved=0; game.lost=0;
    game.nextHorse=10; game.nextFinancialBoss=70; game.finalBossSpawned=false; game.bossTimer=0;
    player.x=CANVAS_W/2; player.y=HORIZON+50; player.hp=100; player.mounted=false; player.weaponType='sword';
    enemies=[]; civilians=[]; items=[]; particles=[];
    
    if(game.bgMountains.length===0) generateEnvironment();
    
    UI.start.style.display='none'; UI.hud.style.display='flex'; UI.controls.style.display='block';
    startMusic();
    loop();
}

function attack() {
    if(player.attacking || player.cooldown>0) return;
    const w = WEAPONS[player.weaponType];
    player.attacking=true; 
    player.attackTimer = player.mounted ? 15 : w.speed;
    player.cooldown = player.mounted ? 10 : w.speed * 1.5;
    playSnd('swing');
}

function changeWeapon() {
    const types = Object.keys(WEAPONS);
    const next = types[Math.floor(Math.random()*types.length)];
    player.weaponType = next;
    showMsg(WEAPONS[next].name, WEAPONS[next].color);
    UI.weapon.innerText = WEAPONS[next].name;
    UI.weapon.style.color = WEAPONS[next].color;
    playSnd('weapon');
}

function spawn() {
    if(game.saved >= 1000) { victory(); return; }
    if(game.frame > 0 && game.frame % 1200 === 0) changeWeapon();
    
    if(game.bossTimer > 0) game.bossTimer--; 

    // Final Boss
    if(game.saved >= 900 && !game.finalBossSpawned) {
        game.finalBossSpawned = true;
        enemies.push({x: CANVAS_W+50, y: HORIZON+50, type: 'boss', name: 'AUTOCRACY', en: '–ê–í–¢–û–ö–†–ê–¢–ò–Ø', color: '#000000', w: 60, h: 80, hp: 100, maxHp: 100, speed: 0.2, dmg: 30});
        showMsg("AUTOCRACY IS HERE!", "#000");
        playSnd('boss');
        return; 
    }

    // Financial Boss
    if(game.score >= game.nextFinancialBoss && game.bossTimer <= 0) {
        let bossData = FINANCIAL_BOSSES[Math.floor(Math.random()*FINANCIAL_BOSSES.length)];
        enemies.push({x:Math.random()<0.5?-40:CANVAS_W+40, y:HORIZON+Math.random()*(CANVAS_H-HORIZON-40), type:'boss', name:bossData.name, color:bossData.color, w:bossData.w, h:bossData.h, hp:bossData.hp, maxHp:bossData.hp, speed:0.4, dmg:20});
        showMsg(bossData.name + "!", bossData.color);
        playSnd('boss');
        game.nextFinancialBoss += 70;
        game.bossTimer = 600; 
    }

    let baseRate = 100 - (game.saved * 0.05);
    if(game.saved > 800) baseRate = 15;
    let rate = Math.max(15, baseRate);

    if(game.frame % Math.floor(rate) === 0) {
        let t='raider'; 
        let e={x:Math.random()<0.5?-20:CANVAS_W+20, y:HORIZON+Math.random()*(CANVAS_H-HORIZON-20), type:t, hp:2, w:14, h:20, speed:0.5+(game.score*0.002), dmg:5};
        if(game.saved > 800) e.speed *= 1.5;
        if(enemies.length < 20) enemies.push(e); // HARD CAP 20
    }
    
    if(game.frame % 150 === 0 && civilians.length < 8) {
        civilians.push({x:game.yurt.x+25, y:game.yurt.y+30, w:10, h:16, vx:(Math.random()-0.5)*1.5, vy:0.5+Math.random(), role:['man','woman','elder'][Math.floor(Math.random()*3)], txt:null, tmr:0});
    }
    if(game.score >= game.nextHorse) {
        items.push({x:CANVAS_W/2+(Math.random()-0.5)*100, y:HORIZON+40, w:24, h:16, type:'horse'});
        game.nextHorse = game.score + 30 + Math.floor(Math.random()*30);
    }
}

function update() {
    if(!game.active) return;
    let spd = player.mounted?3:1.5;
    let dx=0, dy=0;
    if(keys.ArrowUp) dy=-spd; if(keys.ArrowDown) dy=spd; if(keys.ArrowLeft) {dx=-spd; player.dir=-1;} if(keys.ArrowRight) {dx=spd; player.dir=1;}
    if(dx!=0 && dy!=0) { dx*=0.707; dy*=0.707; }

    player.x=Math.max(0,Math.min(CANVAS_W-player.w, player.x+dx));
    player.y=Math.max(HORIZON,Math.min(CANVAS_H-player.h, player.y+dy));
    
    if(player.mounted) {
        player.mountTimer--; UI.horseBar.style.display='block'; UI.horseFill.style.width=(player.mountTimer/player.maxMountTime*100)+"%";
        if(player.mountTimer<=0) { player.mounted=false; UI.horseBar.style.display='none'; }
    }
    
    if(player.attacking) {
        player.attackTimer--;
        const wData = WEAPONS[player.weaponType];
        if(player.attackTimer>2 && player.attackTimer<10) {
            let r = player.mounted?40:wData.range; let hx = player.dir===1?player.x+player.w:player.x-r;
            enemies.forEach(e => {
                if(!e.hit && rectCol(hx, player.y-10, r, player.h+10, e)) {
                    e.hp -= (player.mounted?10:wData.dmg); e.hit=true; e.x+=player.dir*15; spawnPart(e.x,e.y,"#fff",3);
                    if(e.hp<=0) {
                        e.dead=true; game.score++; playSnd('hit'); spawnPart(e.x,e.y,"#b71c1c",8); 
                        if(game.groundDecals.length < 30) game.groundDecals.push({x:e.x, y:e.y+10, c:"#8a1c1c", w:6+Math.random()*6, h:2+Math.random()*2, type:'blood'});
                        let rand = Math.random();
                        if(rand<0.05) items.push({x:e.x, y:e.y, w:10, h:4, type:'sausage'});
                        else if(rand<0.10) items.push({x:e.x, y:e.y, w:8, h:8, type:'bread'});
                        else if(rand<0.15) items.push({x:e.x, y:e.y, w:10, h:10, type:'flask'});
                    }
                }
            });
        }
        if(player.attackTimer<=0) player.attacking=false;
    } else enemies.forEach(e=>e.hit=false);
    if(player.cooldown>0) player.cooldown--;
    
    enemies.forEach(e => {
        if(e.dead) return;
        let t = player; let d = dist(e,player);
        civilians.forEach(c => { if(dist(e,c)<d) t=c; });
        let a = Math.atan2(t.y-e.y, t.x-e.x); e.x+=Math.cos(a)*e.speed; e.y+=Math.sin(a)*e.speed;
        if(rectCol(t.x,t.y,t.w,t.h,e)) {
            if(t===player) { if(game.frame%30===0) { player.hp-=e.dmg; spawnPart(player.x,player.y,"#d32f2f",5); } }
            else { t.dead=true; game.lost++; spawnPart(t.x,t.y,"#b71c1c",5); }
        }
    });
    civilians.forEach(c => {
        c.x+=c.vx; c.y+=c.vy;
        if(!c.txt && Math.random()<0.005) { c.txt=PLEAS[Math.floor(Math.random()*PLEAS.length)]; c.tmr=90; }
        if(c.tmr>0) c.tmr--; else c.txt=null;
        if(c.x<-20||c.x>CANVAS_W+20||c.y>CANVAS_H+20) { c.saved=true; game.saved++; }
    });
    items.forEach(i => {
        if(rectCol(player.x,player.y,player.w,player.h, i)) {
            if(i.type==='horse') { player.mounted=true; player.mountTimer=player.maxMountTime; playSnd('horse'); }
            else if(i.type==='sausage') { player.hp=Math.min(100, player.hp+15); showMsg("QAZY!", "#8d6e63"); playSnd('collect'); }
            else if(i.type==='bread') { player.hp=Math.min(100, player.hp+10); showMsg("NAN!", "#fbc02d"); playSnd('collect'); }
            else { player.hp=Math.min(100, player.hp+25); playSnd('collect'); }
            spawnPart(player.x,player.y,"#76ff03",5); i.collected=true;
        }
    });
    
    // MEMORY PROTECTION
    enemies=enemies.filter(e=>!e.dead && e.x > -100 && e.x < CANVAS_W + 100); 
    civilians=civilians.filter(c=>!c.dead && !c.saved); 
    items=items.filter(i=>!i.collected);
    particles.forEach(p=>{p.x+=p.vx; p.y+=p.vy; p.life--;}); 
    particles=particles.filter(p=>p.life>0);
    
    // STRICT CAPS
    if(particles.length>25) particles.splice(0, particles.length-25);
    if(game.groundDecals.length>30) game.groundDecals.shift();

    if(player.hp<=0) end();
    UI.hp.style.width=Math.max(0,player.hp)+"%";
    UI.score.innerText=game.score; UI.saved.innerText=game.saved; UI.lost.innerText=game.lost;
    spawn(); game.frame++;
}

function drawRect(x,y,w,h,c){ctx.fillStyle=c;ctx.fillRect(Math.floor(x),Math.floor(y),w,h);}

function draw() {
    let grad=ctx.createLinearGradient(0,0,0,CANVAS_H); grad.addColorStop(0,"#0a0814"); grad.addColorStop(1,"#8d4024");
    ctx.fillStyle=grad; ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
    game.bgMountains.forEach(l=>{ ctx.fillStyle=l.c;ctx.beginPath();ctx.moveTo(0,HORIZON);l.p.forEach(p=>ctx.lineTo(p.x,p.y));ctx.lineTo(CANVAS_W,HORIZON);ctx.fill(); });
    ctx.fillStyle="#334d2b"; ctx.fillRect(0,HORIZON,CANVAS_W,CANVAS_H-HORIZON);
    game.groundDecals.forEach(d=>drawRect(d.x,d.y,d.w,d.h,d.c));
    const {x,y}=game.yurt; ctx.fillStyle="#eeeeee";ctx.beginPath();ctx.arc(x+25,y+25,25,Math.PI,0);ctx.fill();
    drawRect(x+2,y+25,46,15,"#dcdcdc"); ctx.fillStyle="#8d6e63"; for(let i=4;i<46;i+=5)drawRect(x+i,y+25,2,15,"#a1887f");
    drawRect(x+15,y+2,20,4,"#b71c1c"); drawRect(x,y+25,50,2,"#b71c1c"); drawRect(x+20,y+28,10,12,"#3e2723");
    let objs=[...enemies.map(e=>({...e,t:'e'})),...civilians.map(c=>({...c,t:'c'})),...items.map(i=>({...i,t:'i'})),{...player,t:'p'}];
    objs.sort((a,b)=>(a.y+a.h)-(b.y+b.h));
    objs.forEach(o => {
        let bob=Math.sin(game.frame*0.2)*2; ctx.save(); ctx.translate(Math.floor(o.x),Math.floor(o.y+bob));
        if(o.t==='i') {
            if(o.type==='horse') { ctx.fillStyle="#fff";ctx.fillRect(0,0,20,14);ctx.fillRect(16,-6,4,8);ctx.fillRect(18,-8,6,4); drawRect(0,10,4,4,"#ddd");drawRect(16,10,4,4,"#ddd"); }
            else if(o.type==='sausage') { ctx.beginPath(); ctx.arc(5,2,6,Math.PI,0); ctx.lineWidth=3; ctx.strokeStyle="#3e2723"; ctx.stroke(); ctx.strokeStyle="#5d4037"; ctx.beginPath(); ctx.arc(5,2,6,Math.PI,0); ctx.stroke(); }
            else if(o.type==='bread') { ctx.fillStyle="#fbc02d"; ctx.beginPath(); ctx.arc(4,4,5,0,Math.PI*2); ctx.fill(); drawRect(2,2,4,4,"#f57f17"); }
            else { drawRect(2,2,6,8,"#795548"); drawRect(3,4,4,4,"#76ff03"); }
        }
        else if(o.t==='c') {
            drawRect(0,0,10,16,o.role==='woman'?"#e91e63":o.role==='elder'?"#757575":"#1e88e5"); drawRect(2,-4,6,4,"#ffccbc");
            if(o.txt) { ctx.save();ctx.translate(0,-20);ctx.fillStyle="white";ctx.fillRect(-10,-10,50,12);ctx.fillStyle="black";ctx.font="8px monospace";ctx.fillText(o.txt,-8,-1);ctx.restore(); }
        }
        else if(o.t==='e') {
            if(o.x<player.x){ctx.translate(o.w,0);ctx.scale(-1,1);}
            if(o.type==='boss') { drawRect(0,0,o.w,o.h,o.color); drawRect(4,-6,o.w-8,6,"#000"); ctx.fillStyle="#fff";ctx.font="8px monospace";ctx.fillText(o.name,0,-12); ctx.fillStyle="red";ctx.fillRect(0,-8,o.w*(o.hp/o.maxHp),2); }
            else { drawRect(0,0,14,20,"#424242");drawRect(4,-4,6,4,"#212121"); }
        }
        else if(o.t==='p') {
            if(o.dir===-1){ctx.translate(o.w,0);ctx.scale(-1,1);}
            if(o.mounted){ctx.translate(0,-10);drawRect(-4,18,24,12,"#fff");drawRect(16,10,6,10,"#fff");drawRect(18,6,8,5,"#fff");}
            drawRect(2,14,4,10,"#3e2723"); drawRect(8,14,4,10,"#3e2723"); drawRect(1,6,12,12,"#5d4037"); drawRect(1,16,12,2,"#8d6e63");
            drawRect(3,2,8,6,"#d2b48c"); drawRect(2,0,10,3,"#4e342e"); drawRect(3,-2,8,2,"#4e342e"); drawRect(2,0,2,8,"#4e342e"); drawRect(10,0,2,8,"#4e342e");
            ctx.translate(0,10); if(o.mounted)ctx.scale(1.5,1.5);
            if(o.attacking) { ctx.rotate((12-o.attackTimer)*0.2); if(o.weaponType === 'sword') { ctx.strokeStyle="#eceff1"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(10, -10, 15, -5); ctx.stroke(); } else { ctx.fillStyle=WEAPONS[o.weaponType].color; ctx.beginPath();ctx.moveTo(0,-2);ctx.lineTo(14,-18);ctx.lineTo(4,-2);ctx.fill(); } ctx.strokeStyle="rgba(255,255,255,0.7)";ctx.lineWidth=1;ctx.beginPath();ctx.arc(0,0,26,-1,1);ctx.stroke(); }
            else { if(o.weaponType === 'sword') { ctx.strokeStyle="#eceff1"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(10,-5); ctx.quadraticCurveTo(12, 5, 14, 8); ctx.stroke(); } else { drawRect(10,-6,3,14,WEAPONS[o.weaponType].color); } }
        }
        ctx.restore();
    });
    particles.forEach(p=>drawRect(p.x,p.y,2,2,p.color));
}

function rectCol(x1,y1,w1,h1,o){return x1<o.x+o.w && x1+w1>o.x && y1<o.y+o.h && y1+h1>o.y;}
function dist(a,b){return Math.sqrt((a.x-b.x)**2+(a.y-b.y)**2);}
function spawnPart(x,y,c,n){for(let i=0;i<n;i++)particles.push({x:x+8,y:y+10,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4,life:20,color:c});}

function end() {
    game.active=false; 
    if (document.fullscreenElement && document.exitFullscreen) { document.exitFullscreen(); }
    UI.hud.style.display='none'; UI.controls.style.display='none'; UI.gameOver.style.display='flex';
    let h=JSON.parse(localStorage.getItem('dala_batyry_scores_v7')||"[]");
    h.push({name:game.username,kills:game.score,saved:game.saved,lost:game.lost});
    h.sort((a,b)=>b.saved-a.saved); h=h.slice(0,5);
    localStorage.setItem('dala_batyry_scores_v7',JSON.stringify(h));
    UI.hofBody.innerHTML=""; h.forEach(e=>{UI.hofBody.innerHTML+=`<tr><td>${e.name}</td><td>${e.kills}</td><td>${e.saved}</td><td>${e.lost}</td></tr>`;});
}

function victory() {
    game.active=false;
    if (document.fullscreenElement && document.exitFullscreen) { document.exitFullscreen(); }
    UI.hud.style.display='none'; UI.controls.style.display='none'; UI.victory.style.display='flex';
}

function loop() { if(game.active) { try { update(); draw(); loopId = requestAnimationFrame(loop); } catch(e){console.error(e);loopId = requestAnimationFrame(loop);} } }
</script>
</body>
</html>
